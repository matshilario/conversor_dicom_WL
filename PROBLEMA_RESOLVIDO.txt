================================================================================
PROBLEMA ENCONTRADO E SOLUÇÃO - COMPATIBILIDADE COM PYLINAC
================================================================================

DATA: 01/12/2025

PROBLEMA IDENTIFICADO:
----------------------
Os arquivos DICOM convertidos do formato .img não funcionavam com a biblioteca
pylinac para análise de Winston-Lutz.

Erro: "Arquivo DICOM inválido"


CAUSA RAIZ:
-----------
Após comparação detalhada entre um arquivo VÁLIDO (gantry180.dcm) e o arquivo
CONVERTIDO (DCM4_Processed_converted.dcm), foi identificado que:

1. O arquivo .img original NÃO possui File Meta Information Header (DICM prefix)

2. Quando lido com pydicom.dcmread(force=True), o file_meta não é criado

3. Quando salvo com .save_as(), o pydicom não adiciona automaticamente o
   file_meta completo

4. O resultado é um arquivo SEM o File Meta Information Header padrão DICOM

5. O pylinac (e muitos outros softwares) REQUER o header padrão DICOM para
   validar e processar o arquivo


ESTRUTURA DO FILE META INFORMATION HEADER:
-------------------------------------------

Um arquivo DICOM padrão deve ter:

1. Preâmbulo de 128 bytes
2. Prefixo "DICM" (4 bytes)
3. File Meta Information Group (0002,xxxx) contendo:
   - Transfer Syntax UID (0002,0010) - OBRIGATÓRIO
   - Media Storage SOP Class UID (0002,0002) - OBRIGATÓRIO
   - Media Storage SOP Instance UID (0002,0003) - OBRIGATÓRIO
   - Implementation Class UID (0002,0012) - RECOMENDADO
   - Implementation Version Name (0002,0013) - RECOMENDADO


COMPARAÇÃO:
-----------

Arquivo VÁLIDO (gantry180.dcm):
  ✓ Transfer Syntax UID: 1.2.840.10008.1.2
  ✓ Implementation Class UID: 2.16.840.1
  ✓ Implementation Version Name: MergeCOM3_390IB2
  ✓ Pode ser lido normalmente por qualquer software DICOM

Arquivo CONVERTIDO (versão antiga):
  ✗ Sem Transfer Syntax UID
  ✗ Sem Implementation Class UID
  ✗ Sem Implementation Version Name
  ✗ Requer force=True para ser lido
  ✗ Incompatível com pylinac


SOLUÇÃO IMPLEMENTADA:
---------------------

O código do conversor foi atualizado para:

1. Detectar se o dataset tem file_meta
2. Criar FileMetaDataset se não existir
3. Adicionar Transfer Syntax UID (Explicit VR Little Endian)
4. Adicionar Media Storage SOP Class UID (copiado do SOPClassUID)
5. Adicionar Media Storage SOP Instance UID (copiado do SOPInstanceUID)
6. Adicionar Implementation Class UID (gerado automaticamente)
7. Adicionar Implementation Version Name (usando versão do pydicom)
8. Salvar com write_like_original=False (força escrita com header padrão)
9. Validar arquivo salvo (tentar ler sem force=True)


CÓDIGO DA CORREÇÃO:
-------------------

```python
from pydicom.dataset import FileMetaDataset
from pydicom.uid import ExplicitVRLittleEndian, generate_uid

# Criar ou corrigir File Meta Information Header
if not hasattr(ds, 'file_meta') or not ds.file_meta:
    ds.file_meta = FileMetaDataset()

# Garantir Transfer Syntax UID
if not hasattr(ds.file_meta, 'TransferSyntaxUID'):
    ds.file_meta.TransferSyntaxUID = ExplicitVRLittleEndian

# Garantir Media Storage SOP Class UID
if not hasattr(ds.file_meta, 'MediaStorageSOPClassUID'):
    if hasattr(ds, 'SOPClassUID'):
        ds.file_meta.MediaStorageSOPClassUID = ds.SOPClassUID

# Garantir Media Storage SOP Instance UID
if not hasattr(ds.file_meta, 'MediaStorageSOPInstanceUID'):
    if hasattr(ds, 'SOPInstanceUID'):
        ds.file_meta.MediaStorageSOPInstanceUID = ds.SOPInstanceUID

# Garantir Implementation Class UID
if not hasattr(ds.file_meta, 'ImplementationClassUID'):
    ds.file_meta.ImplementationClassUID = generate_uid()

# Garantir Implementation Version Name
if not hasattr(ds.file_meta, 'ImplementationVersionName'):
    ds.file_meta.ImplementationVersionName = "PYDICOM_" + pydicom.__version__

# Salvar com header completo
ds.save_as(output_path, write_like_original=False)
```


RESULTADO:
----------

Arquivo CONVERTIDO (versão corrigida):
  ✓ Transfer Syntax UID: 1.2.840.10008.1.2.1 (Explicit VR Little Endian)
  ✓ Implementation Class UID: Gerado automaticamente
  ✓ Implementation Version Name: PYDICOM_3.0.1
  ✓ Pode ser lido normalmente SEM force=True
  ✓ Compatível com pylinac ✅
  ✓ Compatível com outros visualizadores DICOM ✅


ARQUIVOS CRIADOS/ATUALIZADOS:
------------------------------

1. dicom_converter_gui.py - Conversor GUI atualizado com correção
2. fix_dicom_header.py - Script standalone para corrigir headers
3. compare_dicom.py - Script de comparação de estruturas DICOM
4. WL_fixed.dcm - Arquivo de exemplo corrigido


VALIDAÇÃO:
----------

✓ Arquivo pode ser lido com pydicom.dcmread() sem force=True
✓ Arquivo possui File Meta Information Header completo
✓ Arquivo compatível com padrão DICOM
✓ Arquivo pronto para uso com pylinac


REFERÊNCIAS:
------------

- DICOM Standard Part 10: Media Storage and File Format
  https://dicom.nema.org/medical/dicom/current/output/chtml/part10/

- pydicom Documentation - Working with File Meta Information
  https://pydicom.github.io/pydicom/stable/guides/

- pylinac Documentation - Winston-Lutz Analysis
  https://pylinac.readthedocs.io/


================================================================================
